# ТЗ на модуль прибора измерения (драйвер прибора)

## 1	Основные положения
Модуль прибора (драйвер) – это программный модуль, реализующий следующие функции:
*	подключение, прием и передачу информации с/на имитатор прибора;
*	отображение прибора в отдельном окне;
*	отображение заданных значений на имитаторе прибора, а также в окне;
*	калибровка прибора.

## 2	Подключение и отключение прибора 
Работой модуля управляет главная программа (редактор шагов либо клиент). При запуске (либо при других событиях) программа инициализирует модуль, указывая порт, к которому подключен прибор:

Интерфейс прибора | Функция обратного вызова программы
--- | ---
void Init(LPCSTR lpszComPort); | none 	

Модуль при этом должен начать периодически опрашивать указанный порт на предмет его доступности, и как только порт будет доступен – подключиться к нему.
Модуль после установки связи с прибором сообщает программе свои идентификаторы. Программа в ответ вызывает функцию модуля и передает инициализирующую XML:

void OnConnect(LPCSTR lpszIdMeasurer, LPCSTR lpszIdBoard); | none
--- | ---	
none | void InitMeasurer(LPCSTR lpszXML);	

Модуль периодически (1 раз в минуту при отсутствии данных) опрашивает прибор (запрос идентификаторов). В случае отсутствия ответа (в течение 10 секунд после запроса) и если ранее прибор был подключен, то модуль сообщает программе о потере связи. 

none | void OnDisconnect();

После этого модуль должен периодически опрашивать указанный порт на предмет его доступности, и как только порт будет доступен – подключиться к нему (см. выше).
Для показа и скрытия окна отображения прибора в модуле должна быть реализована функция ShowMeasurer(…), в которую передается параметр (0 – скрыть, 1 – отобразить) и которая возвращает новое состояние окна (0 – скрыто, 1 – отображено):

BYTE ShowMeasurer(BYTE bShow);	

## 3	Работа прибора
При установке/снятии щупов на плате, а также при любых манипуляциях с селекторами на самом приборе модуль сообщает программе номера контактов, на которые установлены щупы (даже если изменилось только состояние какого-либо селектора). Программа фиксирует эти данные и возвращает модулю управление (т.к. эта функция обратного вызова вызывается из потока модуля).
Программа в ответ вызывает функцию модуля для отображения измерения, в параметрах передает список значений по различным типам измерений. Модуль прибора в зависимости от установок селекторов выбирает либо нужное значение, либо рассчитывает его (если, например, необходимо отобразить постоянное напряжение, а передано только переменное) и отображает его на приборе, а также в окне отображения. Модуль возвращает качество измерения (включая состояние прибора: измерение, зашкаливание, авария и т.п.), а также тип произведенного измерения:
	
	void OnStateChanged(DWORD dwMinus, DWORD dwPlus)
WORD SetMeasure(int nCount, BYTE *pbMeasureType, double *pdfMeasure);	

Возвращаемые значения состояния (младший байт):
•	1 – измерение невозможно. При данных настройках прибора нет измерения;
•	2 – измерение с высоким качеством;
•	3 – измерение с допустимым качеством. Т.е. результату можно доверять, но зафиксирован он не в идеальном диапазоне;
•	4 – измерение низкого качества. Доверять результату нельзя;
•	5 – первая ступень зашкаливания прибора в бо́льшую сторону;
•	6 – вторая ступень зашкаливания прибора в бо́льшую сторону;
•	7 – первая ступень зашкаливания прибора в меньшую сторону;
•	8 – вторая ступень зашкаливания прибора в меньшую сторону;
•	9 – защитное отключение прибора.

Типы измерений (включая старший байт возвращаемого значения):
•	1 – постоянный ток;
•	2 – переменный ток;
•	3 – постоянное напряжение;
•	4 – переменное напряжение;
•	5 – сопротивление;
•	6 – не определен.

Если вызвать функцию с параметрами SetMeasure(0, NULL, NULL), то стрелка прибора должна быть установлена в «0», функция должна вернуть «0».
Для того, чтобы зажечь или погасить диод, должна быть реализована функция SetLamp(…), в которую передается номер диода (nLamp) и его состояние (0 – погасить, 1 – зажечь) и которая возвращает новое состояние диода (0 – потушен, 1 – включен):
BYTE SetLamp(int nLamp, BYTE btState);	

Для того, чтобы проиграть какой-либо звук, должна быть реализована функция PlaySound(…), в которую передается номер звукового файла:
void PlaySound(int nFile);	

## 4	Калибровка прибора
Калибровка прибора будет производиться в Редакторе шагов. Редактор (при подключенном приборе) описанным выше способом проинициализирует модуль, вызовет функцию установки значения SetMeasure(…)
Далее с помощью функций SetAngle(…) и SetValue(…) установит необходимые отклонения стрелки в окне отображения и на приборе соответственно:
void SetAngle(double dfAngle);	
void SetValue(DWORD dwValue);	

Новые данные необходимо сохранить для дальнейшего использования.

## 5	Обновление прошивки
Функция GetFirmware() должна возвращать версию прошивки в формате YYMMDD:
int GetFirmware();	

Для обновления прошивки необходимо реализовать функцию UpdateFirmware(…), в которую передается полный путь к файлу прошивки и которая по окончании процесса прошивки возвращает номер версии прошивки (см. выше):
int UpdateFirmware(LPCSTR lpszFirmwarePath);	

## 6	Работа при отключенном приборе
Если прибор отключен, необходимо иметь возможность в окне отображения переключать режимы его работы с помощью мышки. Т.е. при клике на кнопках – сообщать в программу о переключении типов измерений. При клике по селектору изменять его положение по- либо против часовой стрелки в зависимости от того, правее или левее его вертикальной оси был клик.
При всех изменениях также, как и при подключенном приборе, сообщать об этом программе (OnStateChanged(…)).
При подключении прибора эта возможность блокируется, а все селекторы приводятся в соответствие с установленным на приборе.

